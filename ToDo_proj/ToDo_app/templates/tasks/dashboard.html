{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="dashboard-container">
    <!-- Header do Dashboard -->
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h2><i class="fas fa-tasks"></i> Minhas Tarefas</h2>

        </div>

        <!-- Estatísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total }}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-number">{{ stats.pending }}</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card in-progress">
                <div class="stat-number">{{ stats.in_progress }}</div>
                <div class="stat-label">Em Andamento</div>
            </div>
            <div class="stat-card completed">
                <div class="stat-number">{{ stats.completed }}</div>
                <div class="stat-label">Concluídas</div>
            </div>
        </div>

        <!-- GRAFICOS -->

        <div class="chart-container">
            <canvas id="taskChart"></canvas>
        </div>

    </div>
    

    <!-- Filtros -->
    <div class="filters-section">
        <form method="GET" class="filters-row" id="filterForm">
            <select name="status" class="filter-select" id="statusFilter">
                <option value="">Todas as Tarefas</option>
                {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if current_status_filter == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>
            
            {% if current_status_filter %}
                <a href="{% url 'tasks:dashboard' %}" class="clear-filters-btn">
                    <i class="fas fa-times"></i> Limpar Filtro
                </a>
            {% endif %}
        </form>
    </div>

    <!-- Lista de Tarefas -->
    <div class="tasks-section">
            <button class="add-task-btn" onclick="openCreateModal()">
                <i class="fas fa-plus"></i>
                Nova Tarefa
            </button>
        {% if page_obj.paginator.num_pages > 1 %}
            <div class="pagination-container">
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% if current_status_filter %}&status={{ current_status_filter }}{% endif %}" 
                           class="pagination-btn first" title="Primeira página">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        <a href="?page={{ page_obj.previous_page_number }}{% if current_status_filter %}&status={{ current_status_filter }}{% endif %}" 
                           class="pagination-btn prev" title="Página anterior">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    {% endif %}

                    <div class="pagination-info">
                        <span class="page-info">
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                    </div>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if current_status_filter %}&status={{ current_status_filter }}{% endif %}" 
                           class="pagination-btn next" title="Próxima página">
                            <i class="fas fa-angle-right"></i>
                        </a>
                        <a href="?page={{ page_obj.paginator.num_pages }}{% if current_status_filter %}&status={{ current_status_filter }}{% endif %}" 
                           class="pagination-btn last" title="Última página">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if page_obj %}
            <div class="tasks-grid">
                {% for task in page_obj %}
                    <div class="task-card" data-task-id="{{ task.id }}">
                        <div class="task-header">
                            <h3 class="task-title">{{ task.title }}</h3>
                            <div class="task-actions">
                                {% if task.status != 'COMPLETADO' %}
                                    <button class="task-action-btn complete" onclick="completeTask({{ task.id }})" title="Marcar como Concluída">
                                        <i class="fas fa-check"></i>
                                    </button>
                                {% endif %}
                                <button class="task-action-btn edit" onclick="openEditModal({{ task.id }})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="task-action-btn delete" onclick="openDeleteModal({{ task.id }}, '{{ task.title|escapejs }}')" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        {% if task.description %}
                            <p class="task-description">{{ task.description }}</p>
                        {% endif %}
                        
                        <div class="task-meta">
                            <span class="task-status {{ task.status }}">{{ task.get_status_display }}</span>
                            <span class="task-date">
                                <i class="fas fa-calendar"></i>
                                {{ task.created_at|date:"d/m/Y H:i" }}
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-clipboard-list"></i>
                <h3>Nenhuma tarefa encontrada</h3>
                <p>
                    {% if current_status_filter %}
                        Tente ajustar o filtro ou criar uma nova tarefa.
                    {% else %}
                        Comece criando sua primeira tarefa!
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal para Criar/Editar Tarefa -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Nova Tarefa</h3>
            <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
        </div>
        
        <form id="taskForm">
            <div class="form-group">
                <label class="form-label" for="taskTitle">Título *</label>
                <input type="text" id="taskTitle" class="form-input" required maxlength="200">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="taskDescription">Descrição</label>
                <textarea id="taskDescription" class="form-textarea" placeholder="Descreva sua tarefa..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="taskStatus">Status</label>
                <select id="taskStatus" class="form-select">
                    {% for value, label in status_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    Criar Tarefa
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Confirmar Exclusão -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirmar Exclusão</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
        </div>
        
        <p>Tem certeza que deseja excluir a tarefa "<span id="deleteTaskTitle"></span>"?</p>
        <p style="color: var(--text-secondary); font-size: 14px;">Esta ação não pode ser desfeita.</p>
        
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">
                Cancelar
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                Excluir
            </button>
        </div>
    </div>
</div>
{% endblock content %}



{% block extra_js %}
<script src="{% static 'js/dashboard.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock extra_js %}